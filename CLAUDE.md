# CLAUDE.md

This file provides guidance for Claude Code when working on this project.

## Project Overview

**Lee-Su-Threads** is a browser extension (Chrome & Firefox) that automatically displays location info for Threads post authors without visiting each profile. It intercepts Threads API responses to extract and cache user profile data.

## Tech Stack

- **Browser Extension Manifest V3** (Chrome & Firefox)
- **Vanilla JavaScript** (ES modules)
- **esbuild** for bundling and minification
- **Vitest** for testing

## Project Structure

```
├── src/                      # Source files
│   ├── manifest.json         # Chrome extension manifest
│   ├── manifest.firefox.json # Firefox extension manifest
│   ├── background.js         # Service worker
│   ├── content.js            # Content script (injects injected.js)
│   ├── injected.js           # Main logic (runs in page context)
│   ├── popup.html/js         # Extension popup UI
│   ├── styles.css            # Injected styles
│   └── lib/
│       ├── dateParser.js     # Date parsing logic (shared module)
│       └── profileParser.js  # Profile parsing logic (shared module)
├── dist/                     # Build output (generated by esbuild)
│   ├── chrome/               # Chrome extension (ready to load)
│   ├── firefox/              # Firefox extension (ready to load)
│   └── shared/               # Bundled JS files (copied to browser dirs)
├── dist-zip/                 # Packaged extensions for store submission
├── test/
│   ├── dateParser.test.js
│   ├── profileParser.test.js
│   └── fixtures/             # Test fixtures (.txt files with API responses)
├── _locales/                 # i18n translations
│   ├── zh_TW/messages.json   # Traditional Chinese (default)
│   ├── zh_CN/messages.json   # Simplified Chinese
│   ├── en/messages.json      # English
│   ├── ja/messages.json      # Japanese
│   └── ko/messages.json      # Korean
└── esbuild.config.js         # Build configuration
```

## Cross-Browser Compatibility

**IMPORTANT:** Always use `browserAPI` instead of `chrome.*` or `browser.*` directly.

All JS files define a compatibility layer at the top:

```javascript
const browserAPI = typeof browser !== "undefined" ? browser : chrome;
```

Use `browserAPI.storage`, `browserAPI.runtime`, `browserAPI.i18n`, etc.

## Localization

- Default locale is `zh_TW` (Traditional Chinese)
- Use `browserAPI.i18n.getMessage("key")` in JavaScript
- Use `__MSG_key__` in manifest.json
- Message keys are defined in `_locales/{locale}/messages.json`

### Adding a new locale

1. Create `_locales/{locale_code}/messages.json`
2. Copy structure from existing locale file
3. Translate all message values

## Key Concepts

### Profile Parsing

- Profiles are extracted from Threads API responses
- Position-based parsing: Joined = 1st pair, Location = 2nd pair
- Supports multiple languages (EN, ZH, JA) with full-width parentheses

### Caching

- Profile data cached in `browserAPI.storage.local`
- Cache expires after 72 hours
- User ID → username mapping cached separately (30 days)

## Build & Development

### Version Management

**IMPORTANT:** Do NOT manually update version numbers in `src/manifest.json`, `src/manifest.firefox.json`, or `src/manifest.firefox-direct.json` during development.

- **Development builds** (`npm run build:watch`): Automatically uses git tag version + 1 (e.g., if latest tag is `v0.3.7`, dev build shows `0.3.8`)
- **Production builds** (`npm run build`): Uses the version from source manifests
- **Release workflow**: Only update manifest versions when creating a release tag

### Building the Extension

```bash
npm run build         # Build both Chrome and Firefox extensions
npm run build:watch   # Build in watch mode (auto-rebuild on changes)
npm run clean         # Remove dist/ directory
```

The build creates separate directories:
- `dist/chrome/` - Chrome extension (load unpacked from here)
- `dist/firefox-amo/` - Firefox AMO version (without update_url)
- `dist/firefox-direct/` - Firefox direct install version (with update_url, load temporary add-on from here)
- `dist/shared/` - Bundled JS files (intermediate build output)

### Testing with web-ext (Firefox)

```bash
# Lint Firefox extension (direct install version)
npx web-ext lint --source-dir=dist/firefox-direct

# Run in Firefox desktop (direct install version)
npm run start:firefox
# or: npx web-ext run --source-dir=dist/firefox-direct

# Run in Firefox for Android (device must be connected via ADB)
npm run start:firefox:android
# The script will auto-detect devices or prompt you to choose
# You can also specify a device: npm run start:firefox:android 56191FDCH007RK
```

### Unit Testing

```bash
npm test              # Run tests once
npm run test:watch    # Run tests in watch mode
```

### Packaging for Store Submission

```bash
bash scripts/package.sh
```

Creates distribution zips in `dist-zip/`:
- `lee-su-threads-chrome-v{version}.zip` - For Chrome Web Store
- `lee-su-threads-firefox-v{version}.zip` - For Firefox Add-ons

## Code Style

- Use ES modules (`import`/`export`) in `src/`
- Shared logic goes in `src/lib/` and can be imported by multiple files
- esbuild bundles everything - no more code duplication!
- Source files are in `src/`, built files in `dist/`

### Security Guidelines (Firefox Compliance)

**NEVER use `innerHTML` for dynamic content** - Firefox flags this as a security warning.

Instead, use safe DOM methods:
- ✅ `element.textContent = "text"` - for plain text
- ✅ `document.createElement()` + `appendChild()` - for structured HTML
- ✅ `element.setAttribute()` - for attributes
- ❌ `element.innerHTML = ...` - **AVOID THIS**

Example:
```javascript
// ❌ BAD - triggers Firefox warnings
element.innerHTML = `<span>${username}</span>`;

// ✅ GOOD - safe and compliant
const span = document.createElement('span');
span.textContent = username;
element.appendChild(span);
```
