(()=>{function M(e,o={}){var t;if(!e||typeof e!="object")return o;if(o._pairs===void 0&&(o._pairs=[],o._currentLabel=null),e["bk.components.Text"]){let s=e["bk.components.Text"],n=s.text,r=s.text_style;r==="semibold"&&n?o._currentLabel=n:r==="normal"&&n&&o._currentLabel&&(o._pairs.push({label:o._currentLabel,value:n}),o._currentLabel=null)}if(e["bk.components.RichText"]){let s=e["bk.components.RichText"].children||[],n="";for(let c of s)c["bk.components.TextSpan"]&&(n+=c["bk.components.TextSpan"].text||"");let r=n.match(/^(.+?)\s*[（(]@([\w.]+)[)）]$/);if(r||(r=n.match(/^(.+?)\s*[（(]@([\w.]+)/)),!r&&(r=n.match(/@([\w.]+)/),r)){o.username=r[1];let c=n.match(/^(.+?)\s*[（(]@/);c&&(o.displayName=c[1].trim())}r&&r[2]&&(o.displayName=(t=r[1])==null?void 0:t.trim(),o.username=r[2])}if(e["bk.components.Image"]){let s=e["bk.components.Image"].url;s&&s.includes("cdninstagram.com")&&(o.profileImage=s)}for(let s of Object.keys(e)){let n=e[s];if(Array.isArray(n))for(let r of n)M(r,o);else typeof n=="object"&&n!==null&&M(n,o)}return o}function k(e){try{let o=e;o.startsWith("for (;;);")&&(o=o.substring(9));let t=JSON.parse(o),s=M(t);if(s._pairs&&s._pairs.length>0){let n=s._pairs,r=["Joined","\u5DF2\u52A0\u5165","\u53C2\u52A0\u65E5","\uAC00\uC785\uC77C","\uAC00\uC785 \uB0A0\uC9DC"],c=["Based in","\u6240\u5728\u5730\u9EDE","\u6240\u5728\u5730","\uC704\uCE58","\uAC70\uC8FC\uC9C0"],u=["Verified by Meta","Meta \u9A57\u8B49","Meta \u9A8C\u8BC1","Meta\u306B\u3088\u308A\u8A8D\u8A3C","Meta\u306B\u3088\u308A\u8A8D\u8A3C\u6E08\u307F","Meta\u8A8D\u8A3C","Meta \uC778\uC99D","Meta \uC778\uC99D \uC644\uB8CC"],h=["Name","\u540D\u7A31","\u540D\u524D","\uC774\uB984"],_=["Former usernames","Previous usernames","\u5148\u524D\u7684\u7528\u6236\u540D\u7A31","\u5148\u524D\u7684\u4F7F\u7528\u8005\u540D\u7A31","\u5148\u524D\u7684\u7528\u6237\u540D\u79F0","\u4EE5\u524D\u306E\u30E6\u30FC\u30B6\u30FC\u30CD\u30FC\u30E0","\uC774\uC804 \uC0AC\uC6A9\uC790 \uC774\uB984"],l=n.filter(i=>!h.includes(i.label)&&!_.includes(i.label)),f=l.find(i=>r.includes(i.label));f&&(s.joined=f.value.split(/\s*[·•]\s*/)[0].trim());let g=l.find(i=>c.includes(i.label));g&&(s.location=g.value);let m=l.find(i=>u.includes(i.label));if(m&&(s.isVerified=!0,s.verifiedDate=m.value),!f&&l.length>=1&&(s.joined=l[0].value.split(/\s*[·•]\s*/)[0].trim()),!g&&l.length>=2){let i=l[1];u.includes(i.label)||(s.location=i.value)}}return delete s._pairs,delete s._currentLabel,delete s._pairsProcessed,s}catch(o){return console.error("Failed to parse response:",o),null}}function D(e,o,t={}){let s={timestamp:new Date().toISOString(),type:e,url:o,method:t.method||"GET",headers:{},body:null,bodyParsed:null};if(t.headers&&(t.headers instanceof Headers?t.headers.forEach((n,r)=>{s.headers[r]=n}):typeof t.headers=="object"&&(s.headers={...t.headers})),t.body){s.body=t.body;try{if(typeof t.body=="string")if(t.body.startsWith("{"))s.bodyParsed=JSON.parse(t.body);else{let n=new URLSearchParams(t.body);s.bodyParsed=Object.fromEntries(n.entries())}else t.body instanceof FormData?(s.bodyParsed={},t.body.forEach((n,r)=>{s.bodyParsed[r]=n})):t.body instanceof URLSearchParams&&(s.bodyParsed=Object.fromEntries(t.body.entries()))}catch(n){s.bodyParseError=n.message}}return console.group(`%c[Threads Extractor] ${e} Request Captured`,"color: #667eea; font-weight: bold;"),console.log("%cURL:","color: #10b981; font-weight: bold;",o),console.log("%cMethod:","color: #10b981; font-weight: bold;",s.method),console.log("%cHeaders:","color: #10b981; font-weight: bold;",s.headers),console.log("%cRaw Body:","color: #10b981; font-weight: bold;",s.body),console.log("%cParsed Body:","color: #10b981; font-weight: bold;",s.bodyParsed),console.log("%cFull Log Object (copy this):","color: #f59e0b; font-weight: bold;"),console.log(JSON.stringify(s,null,2)),console.groupEnd(),window.dispatchEvent(new CustomEvent("threads-request-logged",{detail:s})),s}function F(e,o,t){console.group(`%c[Threads Extractor] ${e} Response Captured`,"color: #764ba2; font-weight: bold;"),console.log("%cURL:","color: #10b981; font-weight: bold;",o),console.log("%cResponse Preview:","color: #10b981; font-weight: bold;",t==null?void 0:t.substring(0,500)),console.groupEnd()}var a=null;function j(e){if(e&&e.fb_dtsg){let o=e.__user&&e.__user!=="0"?e.__user:(a==null?void 0:a.__user)||"0";a={fb_dtsg:e.fb_dtsg,lsd:e.lsd,jazoest:e.jazoest,__user:o,__a:e.__a,__hs:e.__hs,__dyn:e.__dyn,__csr:e.__csr,__comet_req:e.__comet_req,__ccg:e.__ccg,__rev:e.__rev,__s:e.__s,__hsi:e.__hsi,__spin_r:e.__spin_r,__spin_b:e.__spin_b,__spin_t:e.__spin_t,dpr:e.dpr,__d:e.__d},console.log("%c[Threads Extractor] Session tokens captured!","color: #10b981; font-weight: bold;"),window.__threadsExtractorTokens=a}}var d=new Map;window.__threadsUserIdMap=d;var I={};window.addEventListener("message",e=>{var o;if(((o=e.data)==null?void 0:o.type)==="threads-load-userid-cache"){let t=e.data.data,s=0;for(let[n,r]of Object.entries(t))d.has(n)||(d.set(n,r),s++);s>0&&console.log(`%c[Threads Extractor] Loaded ${s} user IDs from cache`,"color: #22c55e; font-weight: bold;")}});var L=null;function z(){L&&clearTimeout(L),L=setTimeout(()=>{Object.keys(I).length>0&&(window.postMessage({type:"threads-new-user-ids",data:I},"*"),I={})},1e3)}function w(e,o,t=""){return d.has(e)?!1:(d.set(e,o),I[e]=o,z(),t&&console.log(`%c[Threads Extractor] Found user (${t}): @${e} -> ${o}`,"color: #f59e0b;"),!0)}function T(e,o="unknown"){if(!(!e||typeof e!="object")){if(e.id&&e.username){let t=String(e.id),s=String(e.username);t.match(/^\d+$/)&&s.match(/^[\w.]+$/)&&w(s,t,"id")}if(e.pk&&e.username){let t=String(e.pk),s=String(e.username);t.match(/^\d+$/)&&s.match(/^[\w.]+$/)&&w(s,t,"pk")}if(e.user&&typeof e.user=="object"){let t=e.user,s=String(t.pk||t.id||""),n=String(t.username||"");s.match(/^\d+$/)&&n.match(/^[\w.]+$/)&&w(n,s,"nested")}for(let t of Object.keys(e)){let s=e[t];Array.isArray(s)?s.forEach(n=>T(n,o)):typeof s=="object"&&s!==null&&T(s,o)}}}var A=window.fetch;window.fetch=async function(...e){var n,r,c,u,h,_,l,f,g,m;let o=((n=e[0])==null?void 0:n.url)||e[0],t=e[1]||{};if(t.body)try{let i=null;t.body instanceof URLSearchParams?i=Object.fromEntries(t.body.entries()):typeof t.body=="string"&&!t.body.startsWith("{")&&(i=Object.fromEntries(new URLSearchParams(t.body).entries())),i&&j(i)}catch{}typeof o=="string"&&o.includes("about_this_profile")&&(console.group(`%c[Threads Extractor] \u{1F50D} API Request: ${o.substring(0,100)}...`,"color: #3b82f6; font-weight: bold;"),console.log("%cFull URL:","color: #10b981;",o),console.groupEnd()),typeof o=="string"&&o.includes("about_this_profile_async_action")&&D("FETCH",o,t);let s=await A.apply(this,e);if(typeof o=="string")try{let p=await s.clone().text();if(p.startsWith("for (;;);")&&(p=p.substring(9)),p.startsWith("{")||p.startsWith("[")){let y=JSON.parse(p);if(o.includes("bulk-route-definitions"))if(console.log("%c[Threads Extractor] \u{1F3AF} Intercepted bulk-route-definitions!","color: #f59e0b; font-weight: bold;"),(r=y.payload)!=null&&r.payloads){let S=d.size;for(let[O,$]of Object.entries(y.payload.payloads)){let U=O;try{U=JSON.parse(`"${O}"`)}catch{}let C=U.match(/^\/@([\w.]+)/);if(C){let N=C[1],H=((_=(h=(u=(c=$.result)==null?void 0:c.exports)==null?void 0:u.rootView)==null?void 0:h.props)==null?void 0:_.user_id)||((m=(g=(f=(l=$.result)==null?void 0:l.exports)==null?void 0:f.hostableView)==null?void 0:g.props)==null?void 0:m.user_id);H&&w(N,String(H),"route")}}let q=d.size;q>S&&console.log(`%c[Threads Extractor] \u{1F3AF} bulk-route-definitions: Found ${q-S} NEW user(s)`,"color: #22c55e; font-weight: bold;")}else console.log("[Threads Extractor] bulk-route-definitions: No payloads found in response");let x=d.size;T(y,o);let E=d.size;E>x&&console.log(`%c[Threads Extractor] \u{1F464} Found ${E-x} NEW user(s) in response`,"color: #22c55e; font-weight: bold;")}}catch{}if(typeof o=="string"&&o.includes("about_this_profile_async_action"))try{let b=await s.clone().text();F("FETCH",o,b);let p=k(b);p&&p.username&&(delete p._pairs,delete p._currentLabel,delete p._pairsProcessed,console.log("[Threads Extractor] Extracted profile info:",p),window.dispatchEvent(new CustomEvent("threads-profile-extracted",{detail:p})))}catch(i){console.error("[Threads Extractor] Error processing response:",i)}return s};var X=XMLHttpRequest.prototype.open,W=XMLHttpRequest.prototype.send,J=XMLHttpRequest.prototype.setRequestHeader;XMLHttpRequest.prototype.open=function(e,o,...t){return this._threadsUrl=o,this._threadsMethod=e,this._threadsHeaders={},X.apply(this,[e,o,...t])};XMLHttpRequest.prototype.setRequestHeader=function(e,o){return this._threadsHeaders&&(this._threadsHeaders[e]=o),J.apply(this,[e,o])};XMLHttpRequest.prototype.send=function(...e){let o=this._threadsUrl;return o&&o.includes("bulk-route-definitions")&&this.addEventListener("load",function(){var t,s,n,r,c,u,h,_,l;try{console.log("%c[Threads Extractor] \u{1F3AF} Intercepted bulk-route-definitions (XHR)!","color: #f59e0b; font-weight: bold;");let f=this.responseText;f.startsWith("for (;;);")&&(f=f.substring(9));let g=JSON.parse(f);if((t=g.payload)!=null&&t.payloads){let m=d.size;for(let[b,p]of Object.entries(g.payload.payloads)){let y=b;try{y=JSON.parse(`"${b}"`)}catch{}let x=y.match(/^\/@([\w.]+)/);if(x){let E=x[1],S=((c=(r=(n=(s=p.result)==null?void 0:s.exports)==null?void 0:n.rootView)==null?void 0:r.props)==null?void 0:c.user_id)||((l=(_=(h=(u=p.result)==null?void 0:u.exports)==null?void 0:h.hostableView)==null?void 0:_.props)==null?void 0:l.user_id);S&&w(E,String(S),"route-xhr")}}let i=d.size;i>m&&console.log(`%c[Threads Extractor] \u{1F3AF} bulk-route-definitions (XHR): Found ${i-m} NEW user(s)`,"color: #22c55e; font-weight: bold;")}}catch(f){console.error("[Threads Extractor] Error processing bulk-route-definitions:",f)}}),o&&o.includes("about_this_profile_async_action")&&(D("XHR",o,{method:this._threadsMethod,headers:this._threadsHeaders,body:e[0]}),this.addEventListener("load",function(){try{F("XHR",o,this.responseText);let t=k(this.responseText);t&&t.username&&(delete t._pairs,delete t._currentLabel,delete t._pairsProcessed,console.log("[Threads Extractor] Extracted profile info (XHR):",t),window.dispatchEvent(new CustomEvent("threads-profile-extracted",{detail:t})))}catch(t){console.error("[Threads Extractor] Error processing XHR response:",t)}})),W.apply(this,e)};async function P(e){if(!a)return console.error("[Threads Extractor] No session tokens available. Browse the feed first."),null;let o="/async/wbloks/fetch/?appid=com.bloks.www.text_post_app.about_this_profile_async_action&type=app&__bkv=22713cafbb647b89c4e9c1acdea97d89c8c2046e2f4b18729760e9b1ae0724f7",t=new URLSearchParams;t.append("__user","0"),t.append("__a",a.__a||"1"),t.append("__req","ext_"+Math.random().toString(36).substring(7)),t.append("__hs",a.__hs||""),t.append("dpr",a.dpr||"2"),t.append("__ccg",a.__ccg||"UNKNOWN"),t.append("__rev",a.__rev||""),t.append("__s",a.__s||""),t.append("__hsi",a.__hsi||""),t.append("__dyn",a.__dyn||""),t.append("__csr",a.__csr||""),t.append("__comet_req",a.__comet_req||"29"),t.append("fb_dtsg",a.fb_dtsg||""),t.append("jazoest",a.jazoest||""),t.append("lsd",a.lsd||""),t.append("__spin_r",a.__spin_r||""),t.append("__spin_b",a.__spin_b||"trunk"),t.append("__spin_t",a.__spin_t||""),t.append("params",JSON.stringify({atpTriggerSessionID:crypto.randomUUID(),referer_type:"TextPostAppProfileOverflow",target_user_id:String(e)})),t.append("__d",a.__d||"www"),console.log("[Threads Extractor] Fetching profile info for user ID:",e),a.fb_dtsg||console.warn("[Threads Extractor] Warning: fb_dtsg token missing, request may fail");try{let s=await A(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8","X-FB-Friendly-Name":"BarcelonaProfileAboutThisProfileAsyncActionQuery"},body:t,credentials:"include"});if(s.status===429)return console.warn("[Threads Extractor] \u26A0\uFE0F Rate limited (429)! Notifying content script..."),window.dispatchEvent(new CustomEvent("threads-rate-limited")),{_rateLimited:!0};let n=await s.text(),r=k(n);if(console.log("[Threads Extractor] Parsed profile info:",r),r&&!r.username){for(let[c,u]of d.entries())if(u===String(e)){r.username=c,console.log(`[Threads Extractor] Resolved username from map: @${c}`);break}}if(r&&(r.username||r.joined||r.location))return delete r._pairs,delete r._currentLabel,delete r._pairsProcessed,r.username||(r.username=`user_${e}`,r._userIdOnly=!0),console.log("[Threads Extractor] Fetched profile info:",r),window.dispatchEvent(new CustomEvent("threads-profile-extracted",{detail:r})),r;console.warn("[Threads Extractor] Could not extract profile info from response. Raw profileInfo:",r)}catch(s){console.error("[Threads Extractor] Error fetching profile info:",s)}return null}function v(){console.log("%c[Threads Extractor] \u{1F511} Scanning page for session tokens...","color: #ec4899; font-weight: bold;");let e={fb_dtsg:[/"fb_dtsg"\s*:\s*"([^"]+)"/,/name="fb_dtsg"\s+value="([^"]+)"/,/"DTSGInitialData"[^}]*"token"\s*:\s*"([^"]+)"/,/\["DTSGInitData",\[\],\{"token":"([^"]+)"/],lsd:[/"lsd"\s*:\s*"([^"]+)"/,/name="lsd"\s+value="([^"]+)"/,/"LSD"[^}]*"token"\s*:\s*"([^"]+)"/],jazoest:[/"jazoest"\s*:\s*"?(\d+)"?/,/name="jazoest"\s+value="(\d+)"/],__user:[/"viewer"\s*:\s*\{[^}]*"id"\s*:\s*"(\d{10,})"/,/"__user"\s*:\s*"?(\d{10,})"?/,/"USER_ID"\s*:\s*"(\d{10,})"/,/"userID"\s*:\s*"(\d{10,})"/,/"viewerID"\s*:\s*"(\d{10,})"/,/"viewer_id"\s*:\s*"?(\d{10,})"?/,/"logged_in_user_id"\s*:\s*"?(\d{10,})"?/,/"current_user_id"\s*:\s*"?(\d{10,})"?/,/\["CurrentUserInitialData"[^\]]*"USER_ID"\s*:\s*"(\d{10,})"/,/\["CurrentUserInitialData"[^\]]*"ACCOUNT_ID"\s*:\s*"(\d{10,})"/]},o={},t=document.querySelectorAll("script:not([src])");return document.querySelectorAll('input[name="fb_dtsg"], input[name="lsd"], input[name="jazoest"]').forEach(n=>{let r=n.getAttribute("name"),c=n.getAttribute("value");c&&!o[r]&&(o[r]=c,console.log(`%c  Found ${r} from input: ${c.substring(0,30)}...`,"color: #f472b6;"))}),t.forEach(n=>{let r=n.textContent||"";for(let[c,u]of Object.entries(e))if(!o[c])for(let h of u){let _=r.match(h);if(_){o[c]=_[1],console.log(`%c  Found ${c}: ${_[1].substring(0,30)}...`,"color: #f472b6;");break}}}),o.fb_dtsg?(a={...a,fb_dtsg:o.fb_dtsg,lsd:o.lsd||(a==null?void 0:a.lsd)||"",jazoest:o.jazoest||(a==null?void 0:a.jazoest)||"",__user:o.__user||(a==null?void 0:a.__user)||"0",__a:(a==null?void 0:a.__a)||"1",__comet_req:(a==null?void 0:a.__comet_req)||"29",__d:(a==null?void 0:a.__d)||"www"},window.__threadsExtractorTokens=a,console.log("%c  \u2705 Session tokens updated from page!","color: #22c55e; font-weight: bold;")):console.log("%c  \u274C Could not find fb_dtsg on page","color: #ef4444;"),o}function R(){console.log("%c[Threads Extractor] \u{1F50E} Scanning page for embedded user data...","color: #8b5cf6; font-weight: bold;");let e=d.size,o=document.querySelectorAll('script[type="application/json"]');console.log(`%c  Found ${o.length} JSON script tags`,"color: #a855f7;"),o.forEach((n,r)=>{let c=n.textContent||"";if(c.includes('"pk"')||c.includes('"username"')||c.includes('"user"'))try{let u=JSON.parse(c);T(u,`json-script#${r}`)}catch{let h=[...c.matchAll(/"pk"\s*:\s*"(\d+)"/g)],_=[...c.matchAll(/"username"\s*:\s*"([\w.]+)"/g)];for(let l of h){let f=l.index,g=l[1];for(let m of _){let i=m.index,b=m[1];if(Math.abs(i-f)<500){w(b,g,"regex");break}}}}}),document.querySelectorAll("script:not([src]):not([type])").forEach(n=>{let r=n.textContent||"";if(r.includes('"pk"')&&r.includes('"username"')){let c=[...r.matchAll(/"pk"\s*:\s*"(\d+)"/g)],u=[...r.matchAll(/"username"\s*:\s*"([\w.]+)"/g)];for(let h of c){let _=h[1],l=h.index;for(let f of u){let g=f[1],m=f.index;if(Math.abs(m-l)<500){w(g,_,"inline");break}}}}});let s=d.size;return console.log(`%c[Threads Extractor] \u{1F4CA} Total users discovered: ${s} (${s-e} new)`,"color: #8b5cf6; font-weight: bold;"),d.size>0&&console.log("  Users:",Object.fromEntries(d)),Object.fromEntries(d)}window.addEventListener("message",async e=>{var o,t,s;if(e.source===window){if(((o=e.data)==null?void 0:o.type)==="threads-userid-request"){let{requestId:n,username:r}=e.data,c=d.get(r)||null;console.log(`[Threads Extractor] User ID lookup for @${r}: ${c}`),window.postMessage({type:"threads-userid-response",requestId:n,userId:c},"*")}if(((t=e.data)==null?void 0:t.type)==="threads-fetch-request"){let{requestId:n,userId:r}=e.data;console.log(`[Threads Extractor] Profile fetch request for user ID: ${r}`);let c=await P(r);window.postMessage({type:"threads-fetch-response",requestId:n,result:c},"*")}(s=e.data)==null||s.type}});window.__threadsFetchProfileInfo=P;window.__threadsGetUserIdMap=()=>Object.fromEntries(d);window.__threadsGetSessionTokens=()=>a;window.__threadsScanPage=R;window.__threadsScanTokens=v;window.__threadsScanAll=()=>(v(),R(),{tokens:a,users:Object.fromEntries(d)});console.log("[Threads Extractor] Network interceptor injected");console.log("[Threads Extractor] Available functions:");console.log("  - window.__threadsFetchProfileInfo(userId) - Fetch profile info by user ID");console.log("  - window.__threadsGetUserIdMap() - Get all discovered username -> userId mappings");console.log("  - window.__threadsGetSessionTokens() - Get captured session tokens");console.log("  - window.__threadsScanPage() - Scan page for embedded user data");console.log("  - window.__threadsScanTokens() - Scan page for session tokens");console.log("  - window.__threadsScanAll() - Scan for both tokens and users");document.readyState==="complete"?setTimeout(()=>{v(),R()},1e3):window.addEventListener("load",()=>setTimeout(()=>{v(),R()},1e3));})();
//# sourceMappingURL=injected.js.map
