(()=>{function F(t){if(!t)return null;let e={january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11,jan:0,feb:1,mar:2,apr:3,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11,"1\u6708":0,"2\u6708":1,"3\u6708":2,"4\u6708":3,"5\u6708":4,"6\u6708":5,"7\u6708":6,"8\u6708":7,"9\u6708":8,"10\u6708":9,"11\u6708":10,"12\u6708":11,"1\uC6D4":0,"2\uC6D4":1,"3\uC6D4":2,"4\uC6D4":3,"5\uC6D4":4,"6\uC6D4":5,"7\uC6D4":6,"8\uC6D4":7,"9\uC6D4":8,"10\uC6D4":9,"11\uC6D4":10,"12\uC6D4":11},s=t.match(/(\d{4})/);if(!s)return null;let n=parseInt(s[1],10),a=null,i=t.match(/(\d{1,2})[月월]/);if(i)a=parseInt(i[1],10)-1;else{let o=t.toLowerCase();for(let[r,d]of Object.entries(e))if(o.includes(r)){a=d;break}}return a===null?null:new Date(n,a,1)}function q(t,e=2,s=new Date){let n=F(t);if(!n)return!1;let a=new Date(s.getFullYear(),s.getMonth()-e,1);return n>=a}var u=typeof browser<"u"?browser:chrome,m=new Map,l=[],T=!1,D=!1,y=!0,x=0,N=800,P=2e3,A=3600*1e3,$=5,U=500,h=new Map;function B(){let t=document.createElement("script");t.src=u.runtime.getURL("injected.js"),t.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(t)}window.addEventListener("threads-profile-extracted",t=>{let e=t.detail;e&&e.username&&(m.set(e.username,e),u.runtime.sendMessage({type:"PROFILE_INFO_EXTRACTED",data:e}),C(e))});window.addEventListener("threads-rate-limited",()=>{console.warn("[Threads Extractor] Rate limited! Pausing auto-fetch for 1 hour."),x=Date.now()+A,H()});window.addEventListener("message",t=>{var e;if(((e=t.data)==null?void 0:e.type)==="threads-new-user-ids"){let s=t.data.data;s&&Object.keys(s).length>0&&u.runtime.sendMessage({type:"STORE_USER_IDS",data:s})}});function H(){let t=document.getElementById("threads-rate-limit-toast");t&&t.remove();let e=document.createElement("div");e.id="threads-rate-limit-toast";let s=u.i18n.getMessage("rateLimitWarning")||"\u26A0\uFE0F Too many location queries. Rate limited by Threads.",n=u.i18n.getMessage("rateLimitPopupHint")||"You can turn off auto-query in the popup.",a=u.i18n.getMessage("rateLimitOpenSettings")||"How to Use",i=document.createElement("span");i.textContent=s;let o=document.createElement("span");o.className="threads-rate-limit-hint",o.textContent=n;let r=document.createElement("button");r.id="threads-open-settings-btn",r.textContent=a;let d=document.createElement("button");d.id="threads-dismiss-toast",d.textContent="\u2715",e.appendChild(i),e.appendChild(o),e.appendChild(r),e.appendChild(d),document.body.appendChild(e),document.getElementById("threads-open-settings-btn").addEventListener("click",()=>{u.runtime.sendMessage({type:"OPEN_ONBOARDING"})}),document.getElementById("threads-dismiss-toast").addEventListener("click",()=>{e.remove()}),setTimeout(()=>{e.parentElement&&e.remove()},A)}function C(t){let e=t.username;document.querySelectorAll(`.threads-fetch-btn[data-username="${e}"]`).forEach(n=>{var i,o,r;if((o=(i=n.previousElementSibling)==null?void 0:i.classList)!=null&&o.contains("threads-profile-info-badge"))return;let a=O(t);(r=n.parentElement)==null||r.insertBefore(a,n),n.style.display="none"})}function Q(t){var a;let e=t,s=0,n=15;for(;e&&s<n;){if(e.getAttribute&&(e.getAttribute("data-pressable-container")==="true"||(a=e.classList)!=null&&a.contains("x1lliihq")||e.tagName==="ARTICLE"))return e;e=e.parentElement,s++}return null}function O(t){let e=document.createElement("span");e.className="threads-profile-info-badge";let s=u.i18n.getMessage("joined")||"Joined",n=q(t.joined),a=u.i18n.getMessage("newUser")||"NEW";if(t.location)e.textContent=t.location,e.title=`${s}: ${t.joined||"Unknown"}`;else{let i=u.i18n.getMessage("noLocation")||"No location";e.textContent=i,e.title=t.joined?`${s}: ${t.joined}`:i}if(n&&!t.isVerified){let i=document.createElement("span");i.className="threads-new-user-tag",i.textContent=`[${a}]`,e.appendChild(i)}return e}async function Y(t,e){if(m.has(t)){let o=m.get(t);C(o),e.style.display="none";return}let s=Math.random().toString(36).substring(7),n=await new Promise(o=>{let r=d=>{var f,c;((f=d.data)==null?void 0:f.type)==="threads-userid-response"&&((c=d.data)==null?void 0:c.requestId)===s&&(window.removeEventListener("message",r),o(d.data.userId))};window.addEventListener("message",r),window.postMessage({type:"threads-userid-request",requestId:s,username:t},"*"),setTimeout(()=>{window.removeEventListener("message",r),o(null)},2e3)});if(!n){e.textContent="\u2753",e.title="User ID not found. Click to retry.",e.disabled=!1;return}let a=Math.random().toString(36).substring(7),i=await new Promise(o=>{let r=d=>{var f,c;((f=d.data)==null?void 0:f.type)==="threads-fetch-response"&&((c=d.data)==null?void 0:c.requestId)===a&&(window.removeEventListener("message",r),o(d.data.result))};window.addEventListener("message",r),window.postMessage({type:"threads-fetch-request",requestId:a,userId:n},"*"),setTimeout(()=>{window.removeEventListener("message",r),o(null)},1e4)});i?i._rateLimited?(e.textContent="\u{1F504}",e.title="Rate limited. Click to retry later.",e.disabled=!1):e.style.display="none":(e.textContent="\u{1F504}",e.title="Failed to load. Click to retry.",e.disabled=!1)}async function M(){if(!(T||l.length===0)){if(!y){console.log("[Threads Extractor] Auto-query disabled. Skipping queue processing.");return}if(Date.now()<x){console.log("[Threads Extractor] Rate limit cooldown active. Skipping queue processing.");return}for(T=!0;l.length>0;){if(Date.now()<x){console.log("[Threads Extractor] Rate limit triggered. Stopping queue processing.");break}let{username:t,btn:e}=l.shift();if(console.log(`[Threads Extractor] Processing @${t}, queue length: ${l.length}`),m.has(t)){let s=m.get(t);C(s),e.style.display="none";continue}e.textContent="\u23F3",await Y(t,e),l.length>0&&await new Promise(s=>setTimeout(s,N))}T=!1}}function W(t,e){if(m.has(t))return;let s=l.findIndex(n=>n.username===t);if(s!==-1){let n=l.splice(s,1)[0];l.unshift(n);return}for(l.unshift({username:t,btn:e});l.length>$;){let n=l.pop();n&&n.btn&&S.observe(n.btn)}D&&M()}var S=new IntersectionObserver(t=>{t.forEach(e=>{let s=e.target,n=s.getAttribute("data-username");if(n)if(e.isIntersecting){if(!h.has(n)&&!m.has(n)){let a=setTimeout(()=>{h.has(n)&&(h.delete(n),W(n,s),S.unobserve(s))},U);h.set(n,a)}}else h.has(n)&&(clearTimeout(h.get(n)),h.delete(n))})},{threshold:.1});function R(){document.querySelectorAll("time:not([data-threads-info-added])").forEach(e=>{var f;e.setAttribute("data-threads-info-added","true");let s=Q(e);if(!s||s.querySelector(".threads-fetch-btn"))return;let n=s.querySelector('a[href^="/@"]');if(!n)return;let i=n.getAttribute("href").match(/^\/@([\w.]+)/);if(!i)return;let o=i[1];if(m.has(o)&&s.querySelector(".threads-profile-info-badge"))return;if(m.has(o)){let c=e.closest("span")||e.parentElement;if(c!=null&&c.parentElement){c.parentElement.style.alignItems="center";let b=O(m.get(o));c.parentElement.insertBefore(b,c.nextSibling)}return}let r=document.createElement("button");r.className="threads-fetch-btn",r.textContent="\u{1F4CD}",r.title=`Get location for @${o}`,r.setAttribute("data-username",o);let d=e.closest("span")||e.parentElement;d&&(d.parentElement&&(d.parentElement.style.alignItems="center"),(f=d.parentElement)==null||f.insertBefore(r,d.nextSibling)),r.addEventListener("click",async c=>{c.preventDefault(),c.stopPropagation(),r.disabled=!0,r.textContent="\u23F3";let b=Math.random().toString(36).substring(7),L=await new Promise(E=>{let I=g=>{var p,w;((p=g.data)==null?void 0:p.type)==="threads-userid-response"&&((w=g.data)==null?void 0:w.requestId)===b&&(window.removeEventListener("message",I),E(g.data.userId))};window.addEventListener("message",I),window.postMessage({type:"threads-userid-request",requestId:b,username:o},"*"),setTimeout(()=>{window.removeEventListener("message",I),E(null)},2e3)});if(L){console.log(`[Threads Extractor] Found user ID for @${o}: ${L}`);let E=Math.random().toString(36).substring(7);await new Promise(g=>{let p=w=>{var _,v;((_=w.data)==null?void 0:_.type)==="threads-fetch-response"&&((v=w.data)==null?void 0:v.requestId)===E&&(window.removeEventListener("message",p),g(w.data.result))};window.addEventListener("message",p),window.postMessage({type:"threads-fetch-request",requestId:E,userId:L},"*"),setTimeout(()=>{window.removeEventListener("message",p),g(null)},1e4)})?r.style.display="none":(r.textContent="\u{1F504}",r.title="Failed to load. Click to retry.",r.disabled=!1)}else console.log(`[Threads Extractor] Could not find user ID for @${o}`),r.textContent="\u2753",r.title="User ID not found. Try scrolling or clicking on their profile first.",r.disabled=!1}),S.observe(r)})}function j(){let t=new MutationObserver(e=>{clearTimeout(t._timeout),t._timeout=setTimeout(()=>{R()},500)});t.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",()=>{clearTimeout(t._timeout),t.disconnect()},{once:!0})}function k(){console.log("[Threads Extractor] Content script loaded"),B(),setTimeout(R,1e3),j(),u.runtime.sendMessage({type:"GET_CACHED_PROFILES"}).then(t=>{if(t)for(let[e,s]of Object.entries(t))m.set(e,s)}).catch(t=>{console.warn("[Threads Extractor] Failed to load cached profiles:",t)}),u.runtime.sendMessage({type:"GET_USER_ID_CACHE"}).then(t=>{if(t&&Object.keys(t).length>0){let e={};for(let[s,n]of Object.entries(t))e[s]=n.userId;console.log(`[Threads Extractor] Loaded ${Object.keys(e).length} cached user IDs`),window.postMessage({type:"threads-load-userid-cache",data:e},"*")}}).catch(t=>{console.warn("[Threads Extractor] Failed to load cached user IDs:",t)}),setTimeout(()=>{D=!0,console.log("[Threads Extractor] Auto-fetch enabled"),M()},P)}u.storage.local.get(["autoQueryEnabled"]).then(t=>{y=t.autoQueryEnabled!==!1});u.runtime.onMessage.addListener(t=>{t.type==="AUTO_QUERY_CHANGED"&&(y=t.enabled,console.log("[Threads Extractor] Auto-query",y?"enabled":"disabled"),y&&M())});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",k):k();})();
//# sourceMappingURL=content.js.map
